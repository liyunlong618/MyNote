# GAS 2.8 配置多播
- <font color=#DC2D1E>**UOverlayWidgetController中创建动态多播；此时当ASC组件调用->获取游戏属性值更改的委托（GetGameplayAttributeValueChangeDelegate），然后绑定回调，回调时广播到UI中，这样就完成了发布更新的架构**</font>
- <font color=#DC2D1E>**关键点：**</font>
    - <font color=#DC2D1E>**1.动态单播，在c++中声明，蓝图中绑定回调**</font>
        - <font color=#DC2D1E>`**2.AbilitySystemComponent->GetGameplayAttributeValueChangeDelegate(AuraAttributeSet->GetHealthAttribute()).AddUObject(this,&UOverlayWidgetController::HealthChanged);**`</font>
            -  ![图片](./GAS 2.8 配置多播-幕布图片-351487-201657.png)
    - <font color=#DC2D1E>`**ASC组件**`</font>  <font color=#DC2D1E>**调用 获取属性变化委托，传入特定类型属性，且 回调函数形参 必须为**</font> <font color=#DC2D1E>`**const FOnAttributeChangeData**`</font> <font color=#DC2D1E>**类型**</font>
        - <font color=#DC2D1E>`**void HealthChanged(const FOnAttributeChangeData& Data);**`</font>
- UAuraWidgetController中写一个多播的虚函数，方便子类重写
    -  ![图片](./GAS 2.8 配置多播-幕布图片-300257-600117.png)
    -  ![图片](./GAS 2.8 配置多播-幕布图片-690951-180601.png)
- UAuraWidgetController的子类UOverlayWidgetController中
    - 创建动态多播
        -  ![图片](./GAS 2.8 配置多播-幕布图片-454723-561167.png)
    - 重写多播的虚函数
        - 头文件
            -  ![图片](./GAS 2.8 配置多播-幕布图片-57845-397184.png)
        - 源文件
            -  ![图片](./GAS 2.8 配置多播-幕布图片-45507-355047.png)
- HUD中初始化时，广播属性
    -  ![图片](./GAS 2.8 配置多播-幕布图片-941418-124962.png)
- 配置完成
- 将HP和MP的小UI，变成变量
    -  ![图片](./GAS 2.8 配置多播-幕布图片-13167-190666.png)
- WBP_Overlay中使用这两个变量调用SetWidgetController函数
    -  ![图片](./GAS 2.8 配置多播-幕布图片-556372-433918.png)
- 把UOverlayWidgetController（WidgetController的子类）类 加上 蓝图可识别该类的宏
    -  ![图片](./GAS 2.8 配置多播-幕布图片-242039-824055.png)
- HP这个小UI中，WidgetController就可以Cast子类了
    -  ![图片](./GAS 2.8 配置多播-幕布图片-434921-288783.png)
- 梳理/帮助理解 ：此时，因为HUD中已经调用了SetWidgetController函数，而调用这个函数就会触发相应AuraUserWidget中的WidgetController的WidgetControllerSet(在蓝图中实现的函数)
    - **首先有一个前提，就是根据UserWidget中的逻辑：**
    - **只要调用SetWidgetController，就会触发该UserWidget的WidgetControllerSet(在蓝图中实现的函数)**
    - **下面是** **步骤讲解**
    - 1.HUD初始化时调用WBP_Overlay的SetWidgetController函数
        -  ![图片](./GAS 2.8 配置多播-幕布图片-250252-686462.png)
    - 2.此时触发WBP_Overlay的WidgetControllerSet函数；并调用HP和MP这两个小UI的SetWidgetController函数
        -  ![图片](./GAS 2.8 配置多播-幕布图片-729622-845867.png)
    - 2.此时触发WBP_GlobeProgressBar_HP的WidgetControllerSet函数
        -  ![图片](./GAS 2.8 配置多播-幕布图片-76013-34634.png)
- 创建UOverlayWidgetController蓝图类
    -  ![图片](./GAS 2.8 配置多播-幕布图片-611290-473844.png)
    -  ![图片](./GAS 2.8 配置多播-幕布图片-845771-844253.png)
- 修改BP_AuraHUD中的OverlayWidgetControllerClass类 为蓝图类BP_OverlayWidgetController
    -  ![图片](./GAS 2.8 配置多播-幕布图片-15170-897420.png)
- HP小UI中绑定多播 ![图片](./GAS 2.8 配置多播-幕布图片-766309-245257.png)
    -  ![图片](./GAS 2.8 配置多播-幕布图片-830430-915199.png)
- 在小UI的基类中创建设置百分比的函数 ![图片](./GAS 2.8 配置多播-幕布图片-594719-746796.png)
    -  ![图片](./GAS 2.8 配置多播-幕布图片-685100-804151.png)
- HP小UI中调用 基类中设定百分比的函数 ![图片](./GAS 2.8 配置多播-幕布图片-281154-459296.png)
    -  ![图片](./GAS 2.8 配置多播-幕布图片-223643-924199.png)
- 在UAuraWidgetController中创建一个 外部调用就可以绑定多播绑定在自身的函数(以前都是写在BeginPlay里面，这里是规范化)
    -  ![图片](./GAS 2.8 配置多播-幕布图片-932484-70683.png)
    -  ![图片](./GAS 2.8 配置多播-幕布图片-584566-475412.png)
    - 想在子类中，方便使用，所以在父类中创建虚函数，方便子类重写
- 在UOverlayWidgetController中创建并绑定 属性变化多播和回调
    -  ![图片](./GAS 2.8 配置多播-幕布图片-486807-577285.png)
    -  ![图片](./GAS 2.8 配置多播-幕布图片-337665-393189.png)
    - **效果是，在别处调用UOverlayWidgetController对象的BindCallbacksToDependencies函数，就能绑定多播到UOverlayWidgetController对象上，所以建议(这步操作在该对象初始化时调用一次)**
- 现在需要在HUD初始化UOverlayWidgetController对象时绑定多播
    -  ![图片](./GAS 2.8 配置多播-幕布图片-423828-856517.png)
- UAuraAttributeSet中暂时修改初始HP为50.f
    -  ![图片](./GAS 2.8 配置多播-幕布图片-517160-805008.png)
- 梳理/帮助理解 : 此时为 **发布更新设计模式** 当ASC属性更新时通过多播，广播给UOverlayWidgetController，再由UOverlayWidgetController多播，广播给UI
- 此时效果gif，说明已经绑定了UI效果 ![图片](./GAS 2.8 配置多播-幕布图片-175010-650368.gif)
- 考试题：参考HP的部分，制作一下蓝的部分，要求捡血瓶以后，掉MP，同步UI ![图片](./GAS 2.8 配置多播-幕布图片-592669-760682.png)
- 参考HP的部分绑定MP的多播
    - 在UOverlayWidgetController中
        -  ![图片](./GAS 2.8 配置多播-幕布图片-40767-940326.png)
        -  ![图片](./GAS 2.8 配置多播-幕布图片-698148-199373.png)
    - 我在基类中创建了保存BP OverlayWidgetController的变量 ![图片](./GAS 2.8 配置多播-幕布图片-832956-792377.png)
        - 这样小部件都可以直接Set和Get该变量 ![图片](./GAS 2.8 配置多播-幕布图片-923776-638884.png)
    - UI中
        -  ![图片](./GAS 2.8 配置多播-幕布图片-381137-359704.png)
- **此时，有一个问题就是，UP说可以运行联机模式，但是我运行联机模式时，EnhancedSubsystem报nullptr，断言后直接崩溃**
    - 2人联机模式下
        -  ![图片](./GAS 2.8 配置多播-幕布图片-233118-382167.png)
            - 找到原因是，多人模式下，PlayerController中的BeginPlay，在服务器和客户端各调用一次，但此时，客户端还没有加载完毕，此时GetLocalPlayer为空(因为还没加载完)所以PC中的 `**EnhancedSubsystem = nullptr**` **，** 等加载完毕后(也就是LocalPlayer不为空),还会再调用一次服务器的PlayerController的BeginPlay，此时EnhancedSubsystem才可以正常获得，所以得出结论，2人联机模式下，服务器会调用两次PC的BeginPlay(因为重新申请地址)
        - 1.服务器端在第一次调用 BeginPlay() 时，设置自己的增强输入子系统。
        - 2.客户端连接到服务器后，服务器发送一条特定的网络消息给客户端。
        - 3.客户端收到服务器发送的网络消息后，执行相应的操作，比如设置客户端的增强输入子系统。
    - 三人时 ![图片](./GAS 2.8 配置多播-幕布图片-249109-355672.png)